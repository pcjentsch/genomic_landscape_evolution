module SarsEvoModel
export main
using BenchmarkTools
using Dates
using ProgressMeter
using Setfield
#Ontario population
#Size of antigenic grid
const w = 25
const h = 25
function map_coords_to_model_space(coords_x, coords_y; limx=(1, 10), limy=(1, 10))
    lx_l, lx_u = limx
    ly_l, ly_u = limy
    return trunc.(Int,
        (
            (coords_x - lx_l) / (lx_u - lx_l) * (w - 1) + 1,
            (coords_y - ly_l) / (ly_u - ly_l) * (h - 1) + 1,
        )
    )
end
include("antigenic_mapping/antigenic_map.jl")
include("antigenic_mapping/genomic_types.jl")

include("data.jl")
include("model.jl")
include("plotting.jl")
include("antigenic_mapping/analyze_snps.jl")
include("antigenic_mapping/antigenic_map_plotting.jl")
include("antigenic_mapping/io.jl")

lower_triangular(n) = ((i, j) for i in 1:n, j in 1:n if j < i)
const datasets = (
    (
        "uk",
        datapath("uk_sequences/alignments/"),
        datapath("uk_sequences/uk_sequences_metadata_new.tsv"),
        datapath("uk_sequence/uk_lineages.csv"),
    ),
    (
        "usa",
        datapath("usa_sequences/alignments/"),
        datapath("usa_sequences/usa_sequences_metadata.tsv"),
        datapath("usa_sequences/usa_lineages.csv"),
    )
)
function total_variation(A)
    t = 0.0
    for i in 1:first(size(A))-1, j in 1:last(size(A))-1
        t += abs(A[i+1, j] - A[i, j]) + abs(A[i, j] - A[i, j+1])
    end
    return t
end
to_named_tuple_naive(p) = (; (v => getfield(p, v) for v in fieldnames(typeof(p)))...)
using Optimization, ForwardDiff, ReverseDiff, OptimizationNLopt, OptimizationBBO, StatsBase, Zygote
using SciMLSensitivity
function main()

    begin_date = Date(2020, 9, 01)
    location_data = USALocationData()

    inv_infectious_period = 1 / 7
    r_0 = 1.55
    transmission_rate = r_0 * inv_infectious_period
    diffusion_kernel = [sigma(i, j; sigma_x=20.0, sigma_y=20.0, rounding=false) for i = -25:25, j = -25:25]
    diffusion_kernel = diffusion_kernel ./ sum(diffusion_kernel)
    β = Float64[transmission_rate for i in 1:w, j in 1:h]
    sigma_matrix = Float64[sigma(i - k, j - l) for i in 1:w, j in 1:h, k in 1:w, l in 1:h]
    initial_pop = 329.5e6

    const_params = ModelParameters(
        begin_date,
        initial_pop,
        β,
        inv_infectious_period,
        0.07,
        0.0001,
        sigma_matrix,
        location_data,
        diffusion_kernel
    )
    u0 = const_params.u0
    du0 = similar(u0, size(u0))

    # jac_sparsity = Symbolics.jacobian_sparsity((du, u) -> rhs(du, u, params, 0.0), du0, u0)
    jac_sparsity = float.(Symbolics.jacobian_sparsity((du, u) -> rhs(du, u, β, 0.0, const_params), du0, u0))
    incident_cases = sum.(const_params.location_data.cases_by_lineage)
    # display(plot(incident_cases))
    function optimization_objective(x)
        prob = create_model(x, jac_sparsity, const_params)
        sol = solve(prob, Rodas5(); saveat=1:length(const_params))#, sensealg=QuadratureAdjoint(autojacvec=ZygoteVJP()))
        return sol
    end

    function loss(sol, x)
        if sol.retcode != :Success
            return Inf
        end
        l = length(sol.u)
        err = 0
        umone = sum(sol.u[1][1:w, (h*4+1):(h*5)])
        for i in 2:l
            u_i = sum(sol.u[i][1:w, (h*4+1):(h*5)])
            err += (incident_cases[i] - (u_i - umone))^2
            umone = u_i
        end
        err /= l
        # yield()
        return err #+ total_variation(β) * 1e2
    end
    β = Float64[transmission_rate for i in 1:w, j in 1:h]
    x0 = vec(β)
    # @btime $loss($optimization_objective($x0), $x0)

    # @show ForwardDiff.gradient(x -> loss(optimization_objective(x), β), β)
    @show Zygote.gradient(x -> loss(optimization_objective(x), x0), x0)
    # f = OptimizationFunction((x, _) -> loss(optimization_objective(x), x))

    # prob = Optimization.OptimizationProblem(f, x0, 0, lb=fill(0.001, length(x0)), ub=fill(transmission_rate * 1.2, length(x0)))
    # optimizer = solve(prob, BBO_adaptive_de_rand_1_bin_radiuslimited(), maxiters=1000000, maxtime=50_000.0)
    # optimization_objective(optimizer)


    sol = optimization_objective(x0)
    # # return loss(sol, x0)
    plot_solution(sol, const_params)
    # loss(sol, x0)
    # plot_data(location_data)
    # # plot_antigenic_map()
    return optimizer
end

# function map_snp_distances(filter_df)
#     limx = extrema(filter_df.mds_x)
#     limy = extrema(filter_df.mds_y)
#     filter_df.gridded_position = map((x, y) -> map_coords_to_model_space(x, y; limx, limy), filter_df.mds_x, filter_df.mds_y)
#     df = groupby(filter_df, :gridded_position)
#     return df
#     snp_distances_matrix = zeros(25, 25, 25, 25)
#     for ind in CartesianIndices(snp_distances_matrix)

#     end
# end




end


b = [
    0.13196152018490487,
    0.24845698197964974,
    0.06657952244556728,
    0.13021256439730225,
    0.08804288079967461,
    0.06025656588239048,
    0.10859628934256649,
    0.09741603954761124,
    0.2428540966411041,
    0.12018900899988112,
    0.1565617769019207,
    0.08558033793128378,
    0.19818359570086452,
    0.21698920993899934,
    0.16759080213902858,
    0.23830727688548506,
    0.11943295088386381,
    0.136655719105218,
    0.23150666185193855,
    0.06380985212671231,
    0.20664584681016235,
    0.08858188152106829,
    0.20570085887242331,
    0.21853887562526134,
    0.09922708673065551,
    0.09351692967895034,
    0.048474979123131354,
    0.17788362931789503,
    0.18055377174588258,
    0.1135507734098109,
    0.12550806340749557,
    0.204763136089125,
    0.07871215040009498,
    0.16840263069198952,
    0.20881805429425143,
    0.18876615567931826,
    0.14031628096236687,
    0.15733283729847172,
    0.08165072154906175,
    0.028742199917793417,
    0.0967831842524728,
    0.14250417020278316,
    0.02254957438451441,
    0.05083694280072908,
    0.19610196212255213,
    0.17832201335635978,
    0.137401743771383,
    0.08044654895518712,
    0.025096888437246445,
    0.11387174497915983,
    0.05437870177853335,
    0.03904005514454775,
    0.2204144348833945,
    0.1428015393636599,
    0.17050330287266277,
    0.16749009200917664,
    0.16362756894837538,
    0.08900303209284956,
    0.11483084664760974,
    0.06424151218114806,
    0.02063786634395582,
    0.16764801817635933,
    0.0433869532705594,
    0.06666511720248167,
    0.14301698425071308,
    0.1839524885114726,
    0.13300799788844458,
    0.13772039360180835,
    0.08420944840846026,
    0.11658833113604754,
    0.16620958634844457,
    0.10369760647766181,
    0.22212045458377946,
    0.16680729597249414,
    0.03287127334128824,
    0.14824262369486452,
    0.14140160846578811,
    0.18771424083838734,
    0.15712120792389128,
    0.17579838664617953,
    0.10042699501194946,
    0.18857836359799604,
    0.15344999930558595,
    0.12474480386950806,
    0.09680335173928883,
    0.06515914946397554,
    0.19339450463501628,
    0.11940479264884528,
    0.13913719625840365,
    0.19700474922856992,
    0.16859200165889995,
    0.053598660757395486,
    0.06793601919669429,
    0.06564969111522945,
    0.254499061614068,
    0.20770461221024306,
    0.12825249676703313,
    0.04463410469573198,
    0.10510770244739678,
    0.028456378721644502,
    0.13323250592878344,
    0.14536757762350272,
    0.1045346851486024,
    0.11806861059469327,
    0.07189085120870986,
    0.06743069232344928,
    0.14950489571132836,
    0.13084420767973726,
    0.138608897449959,
    0.1974576619719337,
    0.06644499907219059,
    0.10610923918756383,
    0.15418082766180427,
    0.16367163896295792,
    0.12246346143867776,
    0.17078696653558645,
    0.13337840627625996,
    0.0541935248262726,
    0.0963445867931747,
    0.037273639483859054,
    0.06603148777247425,
    0.017903466335895957,
    0.07195479036279077,
    0.09236494425206433,
    0.252898709691824,
    0.13010780472874178,
    0.022061307744569904,
    0.13865635483223632,
    0.09078952063194215,
    0.06537402868712716,
    0.22816271787738568,
    0.13245769289351816,
    0.08424986368901138,
    0.21663299789569643,
    0.08711170374229094,
    0.18733112136841207,
    0.03960962302683164,
    0.16577906472082762,
    0.10060561206214932,
    0.18731980456499353,
    0.16241246523177852,
    0.09624945337149127,
    0.2401687867917225,
    0.2441238274471591,
    0.1292594328361345,
    0.2146994016258856,
    0.07840927305002021,
    0.22172140412256153,
    0.08671112974725342,
    0.24334713584301057,
    0.1193779741849151,
    0.19051592169764575,
    0.20219798930488175,
    0.06514810096950827,
    0.15060617030682322,
    0.1686443586321931,
    0.11046255500704534,
    0.1591775855873148,
    0.003542728039405857,
    0.11783300174091893,
    0.09058419855232029,
    0.06360248105641451,
    0.09237968024967455,
    0.0066514292935112886,
    0.09715591424346583,
    0.1477010264778404,
    0.040324406201149604,
    0.19555151156373254,
    0.18231165728018123,
    0.1506466164007482,
    0.15447327909080855,
    0.06755394585273845,
    0.09390508712423246,
    0.061511836124375455,
    0.25027049109577276,
    0.25070206501048453,
    0.06106104363356438,
    0.15111899383691207,
    0.18419409088089905,
    0.003584789533256333,
    0.16538984288120917,
    0.16780554243334556,
    0.21662043728524177,
    0.11048669694518201,
    0.06508713094909513,
    0.12173786441178958,
    0.029429973200700232,
    0.026894568066395938,
    0.16444101014484477,
    0.16675586438223,
    0.02441134756757823,
    0.14492748604056951,
    0.13142586226331646,
    0.051902281399197094,
    0.12271539941980222,
    0.12457443589277767,
    0.13190516848082373,
    0.003442400589914182,
    0.1714654928422631,
    0.17248221935281338,
    0.19860514812667904,
    0.12219504930248896,
    0.16600424824992657,
    0.1558889425380676,
    0.11633483997468386,
    0.1587394737444259,
    0.15044067531478628,
    0.1160246588456672,
    0.10901348668983965,
    0.1779597424306569,
    0.1529877262662963,
    0.18182386486711824,
    0.06619478387200295,
    0.13442924892946817,
    0.12435003361895366,
    0.2656435698881472,
    0.045805896645106946,
    0.24308980852498432,
    0.12251646825145143,
    0.0881299906508493,
    0.18001621638328905,
    0.206894191317303,
    0.0711269402826023,
    0.09078223126934862,
    0.087492081090941,
    0.006587690415065063,
    0.20980180711969754,
    0.15133953985850665,
    0.16475246116869446,
    0.20864265269832322,
    0.17656128194802076,
    0.18626372171020877,
    0.0888199742214665,
    0.10593723612107142,
    0.09596313668811665,
    0.15414688963080825,
    0.0993638898778281,
    0.14331624857421701,
    0.1575631255095129,
    0.052477869270191255,
    0.2311075113079611,
    0.10090347838117195,
    0.16704310014851312,
    0.10031367883987133,
    0.15932049408984866,
    0.005472887252479217,
    0.12586731732800166,
    0.1232713666901354,
    0.07514972212631953,
    0.10481254589124822,
    0.21713333373014515,
    0.05174761633598748,
    0.07166467360077379,
    0.22202420055491978,
    0.008268466402559155,
    0.17202840731716407,
    0.1638210162880224,
    0.08331290714149968,
    0.14260202544457032,
    0.07125171862703511,
    0.17861223538695617,
    0.09538342549718348,
    0.15410958386441614,
    0.13328406943792706,
    0.09851090239124581,
    0.13529681911435193,
    0.19755622944278803,
    0.1934809395738558,
    0.20570465623820117,
    0.11025708296595849,
    0.06124969345075967,
    0.19881925987385113,
    0.20501634675574168,
    0.19211332444092688,
    0.0040362161579970135,
    0.14865120295265855,
    0.10751062525872195,
    0.07794767599497027,
    0.04561848704929793,
    0.08285350088259148,
    0.01489745910921159,
    0.13775003296149282,
    0.1846295570655917,
    0.07285418908534584,
    0.15263340579752718,
    0.1643482323769692,
    0.11345124799693668,
    0.21806732943692925,
    0.25233441494986514,
    0.19361838728837372,
    0.06496298633625971,
    0.1300721636605445,
    0.11583678274394407,
    0.16036411326869662,
    0.17291947137111277,
    0.06248942931808363,
    0.03490360860990324,
    0.11601965166416585,
    0.09825320810053403,
    0.01496772444351415,
    0.12944363601718692,
    0.022881589217827587,
    0.019941620995916398,
    0.04362032461130125,
    0.11941653849639357,
    0.06030189357318662,
    0.10742045092511746,
    0.11904004879524877,
    0.20582769595937994,
    0.19514642099603757,
    0.1857320001001109,
    0.25298593993497465,
    0.15140757198911164,
    0.13783457189892825,
    0.11782426925340472,
    0.19829990979166426,
    0.1388984691016103,
    0.14115881474418965,
    0.217178849322052,
    0.18380676974419585,
    0.103228897801116,
    0.049938514805377414,
    0.05423370711769497,
    0.2235609677988527,
    0.10718119501247503,
    0.15590008200758537,
    0.08613232187749285,
    0.02477429624642733,
    0.18955942903379758,
    0.16217338030486889,
    0.07401548202486688,
    0.011245360938060507,
    0.17500357778176098,
    0.107498920217305,
    0.2391896560494503,
    0.07585527630660022,
    0.2356972243029375,
    0.2572742603053512,
    0.04121706691439887,
    0.1861140180460903,
    0.17501324742208052,
    0.1958491581425432,
    0.059727792176502675,
    0.18371347067379523,
    0.16208718008409254,
    0.16284510573600902,
    0.22771729177305383,
    0.14874712854478742,
    0.15691713701198595,
    0.23031530186921348,
    0.12383768359567307,
    0.12964764795403155,
    0.15231078567380413,
    0.03207880939453524,
    0.17037379356074436,
    0.09558354091151117,
    0.2182663780149373,
    0.22155854723894636,
    0.12968898408311863,
    0.13050610871368964,
    0.23982370633360567,
    0.07695711479707856,
    0.17633045368979863,
    0.21539456772435078,
    0.2143135358559465,
    0.24649588720224588,
    0.1423476870322629,
    0.06511665655054007,
    0.17373345533483583,
    0.07035497519889751,
    0.018981752397718335,
    0.1139147507180557,
    0.08341664184986083,
    0.2237445683420053,
    0.10089520711474921,
    0.16642377689865534,
    0.16385670481058595,
    0.12022202913830937,
    0.12640153602819687,
    0.20053631494393181,
    0.14859529627488294,
    0.14266757243710532,
    0.07552657349768258,
    0.033800325465282575,
    0.06741905687424926,
    0.054175640740279904,
    0.11984420876657385,
    0.06866691125779385,
    0.2360624482925233,
    0.1872438088241687,
    0.05072176935125686,
    0.19574394533146686,
    0.12428762320409531,
    0.002877030742602981,
    0.19537623733613557,
    0.0427652607082447,
    0.17941373925272128,
    0.003661809877758021,
    0.2636982436261493,
    0.15503793753355966,
    0.0574464030529903,
    0.18211294850795098,
    0.12800623441753903,
    0.15376184489382175,
    0.23344498119736543,
    0.10691188266916832,
    0.08139517836295898,
    0.00569408373925801,
    0.05950473243141599,
    0.1987956211218338,
    0.09936518875648559,
    0.24535656361063138,
    0.14536216925578635,
    0.03819885055635428,
    0.12437210360549592,
    0.07915558567618905,
    0.0438673323793708,
    0.1638969043789751,
    0.1540818112654003,
    0.09927536204181006,
    0.19013018451418112,
    0.26527613838654623,
    0.2297015845000944,
    0.12249696149356205,
    0.022869917015490113,
    0.204768856493318,
    0.0028755644798025533,
    0.13321885519128482,
    0.1506313174468734,
    0.08917893535173674,
    0.007411389905652344,
    0.14150486251114963,
    0.1458890404374906,
    0.25202846691946523,
    0.0038474399414631637,
    0.13483357278463157,
    0.07438818682151863,
    0.039349054673342695,
    0.1688427255502888,
    0.13093538478818967,
    0.18128650543080416,
    0.14084960274921354,
    0.057577611502876574,
    0.009479966048954309,
    0.16200707130336006,
    0.0642776980062415,
    0.1584678117142211,
    0.12711545341686867,
    0.13701760395515522,
    0.2014994974861085,
    0.07523162798529046,
    0.15673179983699165,
    0.13998772645777852,
    0.06560653530271715,
    0.12553769521718758,
    0.16453282784220113,
    0.1086641634360487,
    0.15140627781952862,
    0.23805641134475877,
    0.08588613235893089,
    0.04672930599943137,
    0.13231084923690833,
    0.13437675718923864,
    0.14233730457758637,
    0.1486715120304879,
    0.08379149926479552,
    0.12453992407498331,
    0.1378948151473244,
    0.26333849092984146,
    0.001179052291731198,
    0.01767261828712842,
    0.06241519455871803,
    0.10172070056828161,
    0.16828489503136845,
    0.15934057370350785,
    0.23459576370797608,
    0.17013604278761432,
    0.1107909104193931,
    0.09514492959938377,
    0.19942267308898215,
    0.011933234372566826,
    0.14728782008615593,
    0.14494717796635312,
    0.23155963035763832,
    0.1556220664680086,
    0.14910891242868346,
    0.08637271754423262,
    0.03113118026459969,
    0.1234003521171264,
    0.12541778934876863,
    0.15746188094441976,
    0.14404113278198294,
    0.17883647071464248,
    0.13589311751178107,
    0.20386353780001,
    0.07099852890491017,
    0.21583183459771016,
    0.15944883381106056,
    0.024961105172552185,
    0.10849019277575822,
    0.18599730702430312,
    0.11517465031975224,
    0.2559267846456983,
    0.23968625514856876,
    0.013148091056921135,
    0.03341159544277741,
    0.13047589454339484,
    0.05286335384417319,
    0.1340730020977514,
    0.06955836563024412,
    0.20155636266272808,
    0.2651054846784194,
    0.06270663495802008,
    0.051729512792993385,
    0.10824320616670995,
    0.135178103212165,
    0.08330462399058354,
    0.21744482175467134,
    0.10615567805003943,
    0.05801185237444065,
    0.07500125458830878,
    0.08175643951969053,
    0.09638154205974643,
    0.016318782572330964,
    0.16260314890638483,
    0.16438854187482835,
    0.09489201877433902,
    0.10583609251269996,
    0.1425316075340402,
    0.0405587918920185,
    0.029890069152470444,
    0.03858295792455252,
    0.10833483086352193,
    0.0916226908649434,
    0.23938090735719417,
    0.18773350131302965,
    0.025034416972451734,
    0.08473100228297864,
    0.029401664513555026,
    0.15506273211137586,
    0.05777290629272988,
    0.14842492533506974,
    0.04406762601555198,
    0.1997411349111657,
    0.17686615877625644,
    0.1656100062288465,
    0.07778084115657577,
    0.12394262433315625,
    0.12789390888416938,
    0.19983188534887517,
    0.24358773542919188,
    0.09073619838177134,
    0.13519703061959865,
    0.14866909209423101,
    0.2512844486383346,
    0.21621797711187973,
    0.13711889404279606,
    0.12583498290670952,
    0.1309373837127032,
    0.1843552083991714,
    0.15172998008912864,
    0.025381731778423816,
    0.12556380953718727,
    0.07358337875380688,
    0.18447327725279591,
    0.18154312715982088,
    0.2503391352971732,
    0.10853159476816326,
    0.19298522627747464,
    0.09099362722631493,
    0.12546952491185692,
    0.08765264672571019,
    0.044276710485696424,
    0.1955932205597714,
    0.10547472973332832,
    0.0898892182977084,
    0.13157355567439,
    0.15491714931914266,
    0.12299154785885484,
    0.21719151724458766,
    0.1226888697242815,
    0.001797509135292051,
    0.08070493831241776,
    0.2641841108025887,
    0.09458345138691017,
    0.18316929170529067,
    0.08639042327565163,
    0.030753148625983717,
    0.11254157833281496,
    0.14573991951643814,
    0.1641188906078678,
    0.09179366735536855,
    0.24733468318099022,
    0.09084882729942971,
    0.06402847396239844,
    0.09369554809440221,
    0.1808689334559431,
    0.2050855005536258,
    0.16272611311974494,
    0.2529857927497822,
    0.10058970283974937,
    0.22335614182142838,
    0.13951855409144065,
    0.03231694475712896,
    0.14600157517674447,
    0.1452436476497523,
    0.17835398229096952,
    0.20299940604730898,
    0.040712590364134826,
    0.15760494233358738,
    0.05442035993455632,
    0.09079213069349398,
    0.13016397415457992,
    0.12641112051501183,
    0.12389834475131657,
    0.10800869567992707,
    0.08049180617073977,
    0.12542424630085464,
    0.2264965182229059,
    0.12539703429038723,
    0.17004276245881936,
    0.09981257138325275,
    0.139130682349057,
    0.18370824753950069,
    0.1597179106583846
]